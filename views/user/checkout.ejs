<%- include('../layouts/userHeader') %>

<style>
    .address-message p {
    color: red;
    font-weight: bold;
    font-size: 1.2em; /* Adjust font size as needed */
}

</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="index.html" rel="nofollow">Home</a>
                    <span></span> Shop
                    <span></span> Checkout
                </div>
            </div>
        </div>
        <section class="mt-50 mb-50">
            <div class="container">
                <div class="row">
                    <div class="col-lg-6 mb-sm-15">
                        <div class="toggle_info">
                            <span><i class="fi-rs-user mr-10"></i><span class="text-muted">Already have an account?</span> <a href="#" data-bs-toggle="collapse" class="collapsed" aria-expanded="false">Click here to login</a></span>
                        </div>
                        <div class="panel-collapse collapse login_form" id="loginform">
                            <div class="panel-body">
                                <p class="mb-30 font-sm">If you have shopped with us before, please enter your details below. If you are a new customer, please proceed to the Billing &amp; Shipping section.</p>
                                <form method="post">
                                    <div class="form-group">
                                        <input type="text" name="email" placeholder="Username Or Email">
                                    </div>
                                    <div class="form-group">
                                        <input type="password" name="password" placeholder="Password">
                                    </div>
                                    <div class="login_footer form-group">
                                        <div class="chek-form">
                                            <div class="custome-checkbox">
                                                <input class="form-check-input" type="checkbox" name="checkbox" id="remember" value="">
                                                <label class="form-check-label" for="remember"><span>Remember me</span></label>
                                            </div>
                                        </div>
                                        <a href="#">Forgot password?</a>
                                    </div>
                                    <div class="form-group">
                                        <button class="btn btn-md" name="login">Log in</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="toggle_info">
                            <span><i class="fi-rs-label mr-10"></i><span class="text-muted">Have a coupon?</span> <a href="#coupon" data-bs-toggle="collapse" class="collapsed" aria-expanded="false">Click here to enter your code</a></span>
                        </div>
                        <div class="panel-collapse collapse coupon_form " id="coupon">
                            <div class="panel-body">
                                <p class="mb-30 font-sm">If you have a coupon code, please apply it below.</p>
                                <form method="post">
                                    <div class="form-group">
                                        <input type="text" placeholder="Enter Coupon Code...">
                                    </div>
                                    <div class="form-group">
                                        <button class="btn  btn-md" name="login">Apply Coupon</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="divider mt-50 mb-50"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-25">
                            <h4>Billing Details</h4>
                        </div>
                        
                        
                        
                        <form method="post">
                            <% if(locals.addresses && addresses.length > 0) { %>
                                <% for(let i = 0; i < addresses.length; i++) { %>
                                    <div class="col-lg-6">
                                        <div class="card mb-3 mb-lg-0">
                                            <div class="card-header">
                                                <h5 class="mb-0">Address Type: <%= addresses[i].addresstype %> Address</h5>
                                            </div>
                                            <div class="card-body">
                                                <!-- Use a label to style the checkbox -->
                                                <label class="checkbox-container">Select Address
                                                    <input type="radio" name="selectedAddress" value="<%= addresses[i]._id %>">
                                                    <span class="checkmark"></span>
                                                </label>
                                                <address>
                                                    Name: <%= addresses[i].name %><br>
                                                    House Name: <%= addresses[i].housename %><br>
                                                    Landmark: <%= addresses[i].landmark %><br>
                                                    City: <%= addresses[i].city %><br>
                                                    State: <%= addresses[i].state %><br>
                                                    Pincode: <%= addresses[i].pincode %><br>
                                                    Phone: <%= addresses[i].phone %><br>
                                                    Alternate Phone: <%= addresses[i].altphone %>
                                                </address>
                                                <a href="#" class="btn-small edit-address-btn" data-address-id="<%= addresses[i]._id %>"></a>
                                            </div>
                                        </div>
                                    </div>
                                <% } %>
                            <% } else { %>
                                <div id="addressMessage" class="address-message">
                                    <p>No addresses found !!</p>
                                </div>
                            <% } %>
                        </form>
                        
                        <script>
                            // Function to add the "Click here to add address" link and handle redirection
function addAddressLink() {
    var addressMessage = document.getElementById('addressMessage');
    // Create a new anchor element
    var link = document.createElement('a');
    link.href = "/profile"; // Set the href attribute
    link.textContent = "Click here to add address"; // Set the link text
    link.style.marginLeft = '10px'; // Adjust spacing if needed

    // Append the link to the address message
    addressMessage.appendChild(link);
}

// Call the function to add the link
addAddressLink();

                        </script>
                        <script>
                            // Get all radio buttons
                            const radioButtons = document.querySelectorAll('input[type="radio"]');
                            
                            // Attach event listener to each radio button
                            radioButtons.forEach(button => {
                                button.addEventListener('click', function() {
                                    // Deselect all other radio buttons
                                    radioButtons.forEach(otherButton => {
                                        if (otherButton !== button) {
                                            otherButton.checked = false;
                                        }
                                    });
                                });
                            });
                        </script>
                        
                        <style>
                            /* Style the container for the custom radio button */
                            .checkbox-container {
                                display: inline-block;
                                position: relative;
                                padding-left: 20px;
                                margin-bottom: 12px;
                                cursor: pointer;
                                font-size: 16px;
                            }
                        
                            /* Hide the default radio button */
                            .checkbox-container input {
                                position: absolute;
                                opacity: 0;
                                cursor: pointer;
                                height: 0;
                                width: 0;
                            }
                        
                            /* Style the custom radio button */
                            .checkmark {
                                position: absolute;
                                top: 0;
                                left: 0;
                                height: 16px;
                                width: 16px;
                                background-color: #fff;
                                border: 1px solid #ccc;
                                border-radius: 50%;
                            }
                        
                            /* On mouse-over, add a grey background color */
                            .checkbox-container:hover input ~ .checkmark {
                                background-color: #f4f4f4;
                            }
                        
                            /* When the radio button is checked, add a blue background */
                            .checkbox-container input:checked ~ .checkmark {
                                background-color: #2196F3;
                            }
                        
                            /* Create the dot/indicator (hidden when not checked) */
                            .checkmark:after {
                                content: "";
                                position: absolute;
                                display: none;
                            }
                        
                            /* Show the dot/indicator when the radio button is checked */
                            .checkbox-container input:checked ~ .checkmark:after {
                                display: block;
                            }
                        
                            /* Style the dot/indicator */
                            .checkbox-container .checkmark:after {
                                top: 4px;
                                left: 4px;
                                width: 8px;
                                height: 8px;
                                border-radius: 50%;
                                background: white;
                            }
                        </style>
                        <script>
                         // Get all the "Edit" buttons
                         const editButtons = document.querySelectorAll('.edit-address-btn');
                     
                         // Attach click event listener to each "Edit" button
                         editButtons.forEach(button => {
                             button.addEventListener('click', () => {
                                 const addressID = button.dataset.addressId; // Assuming you have data attribute to store address ID
                                 populateAddressForm(addressID);
                             });
                         });
                     </script>
                        
                        <!-- <div class="mb-20">
                            <h5>Additional information</h5>
                        </div>
                        <div class="form-group mb-30">
                            <textarea rows="5" placeholder="Order notes"></textarea>
                        </div> -->
                    </div>
                    <div class="col-md-6">
                        <div class="order_review">
                            <div class="mb-20">
                                <h4>Your Orders</h4>
                            </div>
                            <div class="table-responsive order_table text-center">
                                <table class="table">
                                    <thead>
                                        <tr>
                                           
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% let subtotal = 0; %>
                                        <% for (let i = 0; i < cart.products.length; i++) { %>
                                            <% let product = cart.products[i]; %>
                                            <tr>
                                                <td class="image product-thumbnail">
                                                    <img src="/assetsb/productImages/<%= product.productId.image[0] %>" alt="#">
                                                </td>
                                                <td>
                                                    <h5><a href="shop-product-full.html"><%= product.productId.product_name %></a></h5>
                                                    <span class="product-qty"><%= product.quantity %></span>
                                                </td>
                                                <% let price = product.productId.discount_price > 0 ? product.productId.discount_price : product.productId.price; %>
                                                <td>&#8377;<%= product.quantity * price %>.00</td>
                                            </tr>
                                            <% subtotal += product.quantity * price; %>
                                        <% } %>
                                        <tr>
                                            <th>SubTotal</th>
                                            <td class="product-subtotal" colspan="2">&#8377;<%= subtotal %>.00</td>
                                        </tr>
                                        <tr>
                                            <th>Shipping</th>
                                            <td colspan="2"><em>Free Shipping</em></td>
                                        </tr>
                                        <tr>
                                            <th>Total</th>
                                            <td colspan="2" class="product-subtotal"><span class="font-xl text-brand fw-900">&#8377;<%= subtotal %>.00</span></td>
                                        </tr>
                                    </tbody>
                                    
                                </table>
                            </div>
                            <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                            <div class="payment_method">
                                <div class="mb-25">
                                    <h5>Payment</h5>
                                </div>
                                <div class="payment_option">
                                    <div class="custome-radio">
                                        <input class="form-check-input" required="" type="radio" name="payment_option" id="exampleRadios3" checked="">
                                        <label class="form-check-label" for="exampleRadios3" data-bs-toggle="collapse" data-target="#bankTranfer" aria-controls="bankTranfer">Direct Bank Transfer</label>
                                        <div class="form-group collapse in" id="bankTranfer">
                                            <p class="text-muted mt-5">There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration. </p>
                                        </div>
                                    </div>
                                    <div class="custome-radio">
                                        <input class="form-check-input" required="" type="radio" name="payment_option" id="exampleRadios4" checked="">
                                        <label class="form-check-label" for="exampleRadios4" data-bs-toggle="collapse" data-target="#checkPayment" aria-controls="checkPayment"> Cash On Delivery</label>
                                        <div class="form-group collapse in" id="checkPayment">
                                            <p class="text-muted mt-5">Please send your cheque to Store Name, Store Street, Store Town, Store State / County, Store Postcode. </p>
                                        </div>
                                    </div>
                                    <div class="custome-radio">
                                        <input class="form-check-input" required="" type="radio" name="payment_option" id="exampleRadios5" checked="">
                                        <label class="form-check-label" for="exampleRadios5" data-bs-toggle="collapse" data-target="#paypal" aria-controls="paypal" onclick="createRazorpayOrder">online payment</label>
                                        <div class="form-group collapse in" id="payment_method">
                                            <p class="text-muted mt-5">Pay via PayPal; you can pay with your credit card if you don't have a PayPal account.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <a href="#" class="btn btn-fill-out btn-block mt-30" id="placeOrderButton">Place Order</a>
                            
                        
                            <script>
                                document.addEventListener("DOMContentLoaded", function () {
                                    // Function to check if the cart is empty
                                    function isCartEmpty() {
                                        // Check if the total amount in the cart is zero or not
                                        var totalAmount = parseFloat(document.querySelector('.product-subtotal span').innerText.replace(/[^0-9.-]+/g, ""));
                                        return totalAmount === 0;
                                    }
                            
                                    // Function to handle placing the order
                                    function placeOrder(addressId, totalAmount, paymentMethod) {
                                        $.ajax({
                                            url: "/placeorder",
                                            method: "POST",
                                            data: {
                                                addressId: addressId,
                                                totalAmount: totalAmount,
                                                paymentMethod: paymentMethod
                                            },
                                            success: function (response) {
                    // Display toast notification for successful order placement
                    Toastify({
                        text: "Order placed successfully!",
                        duration: 3000, // 3 seconds
                        close: true,
                        gravity: "top", // Show toast at the top
                        position: "center", // Center the toast
                        backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)", // Custom background color
                    }).showToast();

                    // Redirect to the profile page after a short delay
                    setTimeout(function () {
                        window.location.href = '/profile';
                    }, 3000);
                },
                                            error: function (xhr, status, error) {
                                                // Display error message to the user
                                                alert("Failed to place order. Please try again later.");
                                                // Log the error for debugging
                                                console.error(xhr, status, error);
                                            }
                                        });
                                    }
                            
                                    // Event listener for clicking the "Place Order" button
                                    document.getElementById('placeOrderButton').addEventListener('click', function () {
                                        // Check if the cart is empty
                                        if (isCartEmpty()) {
                                            // If cart is empty, display SweetAlert
                                            Swal.fire({
                                                icon: 'error',
                                                title: 'Oops...',
                                                text: 'Your cart is empty!',
                                            });
                                        } else {
                                            // Get the selected address ID
                                            var selectedAddressId = document.querySelector('input[name="selectedAddress"]:checked').value;
                                            // Get the total amount
                                            var totalAmount = parseFloat(document.querySelector('.product-subtotal span').innerText.replace(/[^0-9.-]+/g, ""));
                                            // Get the selected payment method
                                            var selectedPaymentMethod = document.querySelector('input[name="payment_option"]:checked').nextElementSibling.textContent.trim();
                            
                                            // Check if all required fields are filled
                                            if (!selectedAddressId) {
                                                alert("Please select an address.");
                                            } else {
                                                // Place the order
                                                placeOrder(selectedAddressId, totalAmount, selectedPaymentMethod);
                                            }
                                        }
                                    });
                                });
                            </script>
                            <script>
                             function createRazorpayOrder(addressId, totalAmount, paymentMethod) {
       const data = {
        addressId: addressId,
        totalAmount: totalAmount,
        paymentMethod: paymentMethod
    };

    fetch('/razorpayorder', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log('Razorpay order created:', data);
        // Handle the response data as needed
    })
    .catch(error => {
        console.error('There was a problem with your fetch operation:', error);
    });
}
   
                            </script>
                            
                            

                            
                        </div>
                    </div>
                </div>






            </div>
        </section>
        
    </main>

    



    














   <%- include('../layouts/userFooter') %>